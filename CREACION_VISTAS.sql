-- Vistas 

drop VIEW VW_CIERRE_NUEVOS ;

CREATE  VIEW `VW_CIERRE_NUEVOS` AS 
SELECT DISTINCT `SUB`.`ANIO` AS `ANIO`, `SUB`.`MES` AS `MES`, `SUB`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `SUB`.`AGENCIA` AS `AGENCIA`, `SUB`.`COD_USUARIO` AS `COD_USUARIO`, `SUB`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `SUB`.`MODELO` AS `MODELO`, `SUB`.`FAMILIA` AS `FAMILIA`, `SUB`.`TIPO` AS `TIPO`, `SUB`.`VALOR` AS `VALOR` FROM  ( SELECT ``.`ANIO` AS `ANIO`, ``.`MES` AS `MES`, ``.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, ``.`AGENCIA` AS `AGENCIA`, ``.`COD_USUARIO` AS `COD_USUARIO`, ``.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, ``.`MODELO` AS `MODELO`, ``.`FAMILIA` AS `FAMILIA`, ``.`TIPO` AS `TIPO`, ``.`VALOR` AS `VALOR` FROM  ( SELECT `A`.`ANIO` AS `ANIO`, `A`.`MES` AS `MES`, `A`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `A`.`AGENCIA` AS `AGENCIA`, `A`.`COD_USUARIO` AS `COD_USUARIO`, `A`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `A`.`VEHICULO_INTERES` AS `MODELO`, `A`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA`, 'TRAFICO' AS `TIPO`, SUM( CASE  WHEN (`A`.`RANKING` = 1) THEN 1 ELSE 0 END ) AS `VALOR` FROM  ( SELECT  YEAR(`T`.`FECHA_CREACION`) AS `ANIO`,  MONTH(`T`.`FECHA_CREACION`) AS `MES`,  DATE(`T`.`FECHA_CREACION`) AS `FECHA`, `T`.`FECHA_CREACION` AS `FECHA_CREACION`, `L`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `TR`.`TRAFICO` AS `TRAFICO`, `A`.`AGENCIA` AS `AGENCIA`, `VE`.`COD_USUARIO` AS `COD_USUARIO`, `VE`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `V`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `V`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES`, `V`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO_INTERES`,  ROW_NUMBER() OVER (PARTITION BY  MONTH(`T`.`FECHA_CREACION`),  YEAR(`T`.`FECHA_CREACION`), `L`.`LINEA_NEGOCIO`, `TR`.`IDENTIFICACION`, `VE`.`COD_USUARIO` ORDER BY  MONTH(`T`.`FECHA_CREACION`), `T`.`FECHA_CREACION`) AS `RANKING` FROM (((((`FC_TRAFICO` as `T`  JOIN `DIM_TRAFICO` as `TR`  ON (`T`.`SK_TRAFICO` = `TR`.`SK_TRAFICO`)) JOIN `DIM_LINEA_NEGOCIO` as `L`  ON (`T`.`SK_LINEA_NEGOCIO` = `L`.`SK_LINEA_NEGOCIO`)) JOIN `DIM_VEHICULOS_INTERES` as `V`  ON (`T`.`SK_VEHICULO_INTERES` = `V`.`SK_VEHICULO_INTERES`)) JOIN `DIM_AGENCIA` as `A`  ON (`T`.`SK_AGENCIA` = `A`.`SK_AGENCIA`)) JOIN `DIM_VENDEDOR` as `VE`  ON (`T`.`SK_VENDEDOR` = `VE`.`SK_VENDEDOR`)) WHERE (`L`.`COD_LINEA_NEGOCIO` = '3') ) AS `A` GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9 HAVING (`A`.`ANIO` > 2018) ) AS `` UNION ALL SELECT ``.`ANIO` AS `ANIO`, ``.`MES` AS `MES`, ``.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, ``.`AGENCIA` AS `AGENCIA`, ``.`COD_USUARIO` AS `COD_USUARIO`, ``.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, ``.`MODELO` AS `MODELO`, ``.`FAMILIA` AS `FAMILIA`, ``.`TIPO` AS `TIPO`, ``.`VALOR` AS `VALOR` FROM  ( SELECT `AA`.`ANIO` AS `ANIO`, `AA`.`MES` AS `MES`, `AA`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `AA`.`AGENCIA` AS `AGENCIA`, `AA`.`COD_USUARIO` AS `COD_USUARIO`, `AA`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `AA`.`MODELO` AS `MODELO`,  IFNULL(`K`.`FAMILIA_VEHICULO_INTERES`,'NO DEFINIDO') AS `FAMILIA`, 'VENTA' AS `TIPO`, `AA`.`VALOR` AS `VALOR` FROM ( ( SELECT  YEAR(`B`.`FECHA`) AS `ANIO`,  MONTH(`B`.`FECHA`) AS `MES`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`AGENCIA` AS `AGENCIA`, `G`.`COD_USUARIO` AS `COD_USUARIO`, `G`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `J`.`MODELO` AS `MODELO`, SUM( CASE  WHEN (`F`.`COD_TIPO_DOCUMENTO` = 'FD') THEN -1 ELSE 1 END ) AS `VALOR` FROM ((((((((`FC_VENTAS_NUEVOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `F`  ON (`A`.`SK_TIPO_DOCUMENTO` = `F`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VENDEDOR` as `G`  ON (`A`.`SK_VENDEDOR` = `G`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) GROUP BY 1, 2, 3, 4, 5, 6, 7 HAVING ( YEAR(`B`.`FECHA`) > 2018) ) AS `AA` LEFT  JOIN  ( SELECT DISTINCT `dvi`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `dvi`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES` FROM `DIM_VEHICULOS_INTERES` as `dvi`  ) AS `K` ON (`K`.`VEHICULO_INTERES` = `AA`.`MODELO`)) ) AS `` ) AS `SUB`;

DROP VIEW VW_VEHICULOS_EXONERADOS;
CREATE  VIEW `VW_VEHICULOS_EXONERADOS` AS SELECT `B`.`FECHA` AS `FECHA`, `C`.`EMPRESA` AS `EMPRESA`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`AGENCIA` AS `AGENCIA`, `F`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `G`.`TIPO_DOCUMENTO` AS `TIPO_DOCUMENTO`, `G`.`COD_TIPO_DOCUMENTO` AS `COD_TIPO_DOCUMENTO`, `H`.`VERSION_VEHICULO` AS `VERSION_VEHICULO`, `I`.`FORMA_PAGO` AS `FORMA_PAGO`, `A`.`SK_FACTURA` AS `SK_FACTURA`, `A`.`SK_COTIZACION` AS `SK_COTIZACION`, `A`.`SK_NO_FISICO` AS `SK_NO_FISICO`, `J`.`CHASIS` AS `CHASIS`, `J`.`MODELO` AS `MODELO`, `K`.`CEDULA` AS `CEDULA`, `M`.`TIPO_EXONERADO` AS `TIPO_EXONERADO`, `A`.`PORCENTAJE_DISCAPACIDAD` AS `PORCENTAJE_DISCAPACIDAD`, `L`.`TIPO_FINANCIACION` AS `TIPO_FINANCIACION`, `L`.`COD_TIPO_FINANCIACION` AS `COD_TIPO_FINANCIACION`, `A`.`COSTO_VEHICULO` AS `COSTO_VEHICULO`, `A`.`PRECIO` AS `PRECIO`, `A`.`SALDO_FINANCIAR` AS `SALDO_FINANCIAR`, `A`.`CUOTA_DE_ALCANCE` AS `CUOTA_DE_ALCANCE`, `A`.`COSTOS_IMPORT` AS `COSTOS_IMPORT`, `A`.`COMISON_SIN_IVA` AS `COMISON_SIN_IVA`, `A`.`COMISION_CON_IVA` AS `COMISION_CON_IVA` FROM ((((((((((((`FC_VENTAS_EXONERADOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_VENDEDOR` as `F`  ON (`A`.`SK_VENDEDOR` = `F`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `G`  ON (`A`.`SK_TIPO_DOCUMENTO` = `G`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VERSION_VEHICULO` as `H`  ON (`A`.`SK_VERSION_VEHICULO` = `H`.`SK_VERSION_VEHICULO`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) LEFT  JOIN `DIM_CLIENTE` as `K`  ON (`A`.`SK_CLIENTE` = `K`.`SK_CLIENTE`)) LEFT  JOIN `DIM_TIPO_FINANCIACION` as `L`  ON (`A`.`SK_TIPO_FINANCIACION` = `L`.`SK_TIPO_FINANCIACION`)) LEFT  JOIN `DIM_TIPO_EXONERADO` as `M`  ON (`A`.`SK_TIPO_EXONERADO` = `M`.`SK_TIPO_EXONERADO`));

DROP VIEW VW_VEHICULOS_NUEVOS ;
CREATE  VIEW `VW_VEHICULOS_NUEVOS` AS SELECT `B`.`FECHA` AS `FECHA`, `C`.`COD_EMPRESA` AS `COD_EMPRESA`, `C`.`EMPRESA` AS `EMPRESA`, `D`.`COD_LINEA_NEGOCIO` AS `COD_LINEA_NEGOCIO`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`COD_AGENCIA` AS `COD_AGENCIA`, `E`.`AGENCIA` AS `AGENCIA`, `F`.`COD_TIPO_DOCUMENTO` AS `COD_TIPO_DOCUMENTO`, `F`.`TIPO_DOCUMENTO` AS `TIPO_DOCUMENTO`, `G`.`COD_USUARIO` AS `COD_USUARIO`, `G`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `H`.`COD_VERSION_VEHICULO` AS `COD_VERSION_VEHICULO`, `H`.`VERSION_VEHICULO` AS `VERSION_VEHICULO`, `I`.`FORMA_PAGO` AS `FORMA_PAGO`, `J`.`CHASIS` AS `CHASIS`, `J`.`MARCA` AS `MARCA`, `J`.`MODELO` AS `MODELO`, `J`.`PLACA` AS `PLACA`, `J`.`SFX` AS `SFX`, `J`.`ANIO_VEHICULO` AS `ANIO_VEHICULO`, `K`.`NOMBRE` AS `NOMBRE`, `K`.`CEDULA` AS `CEDULA`, `K`.`PROVINCIA` AS `PROVINCIA`, `K`.`SEXO` AS `SEXO`, `K`.`TELEFONO` AS `TELEFONO`, `K`.`TELEFONO2` AS `TELEFONO2`, `K`.`TIPO_CLIENTE` AS `TIPO_CLIENTE`, `L`.`COD_TIPO_FINANCIACION` AS `COD_TIPO_FINANCIACION`, `L`.`TIPO_FINANCIACION` AS `TIPO_FINANCIACION`, `A`.`COSTO_VEHICULO` AS `COSTO_VEHICULO`, `A`.`DESCUENTO` AS `DESCUENTO`, `A`.`PRECIO` AS `PRECIO`, `A`.`SUBTOTAL_MASIVO` AS `SUBTOTAL_MASIVO`, `A`.`VALOR_NETO` AS `VALOR_NETO`, `A`.`SALDO_FINANCIAR` AS `SALDO_FINANCIAR`, `A`.`COUTA_DE_ALCANCE` AS `COUTA_DE_ALCANCE`, `A`.`UTILIDAD` AS `UTILIDAD`, `A`.`SK_FACTURA` AS `NRO_FACTURA`, `A`.`SK_COTIZACION` AS `NRO_COTIZACION`, `A`.`SK_NO_FISICO` AS `NRO_FISICO` FROM (((((((((((`FC_VENTAS_NUEVOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `F`  ON (`A`.`SK_TIPO_DOCUMENTO` = `F`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VENDEDOR` as `G`  ON (`A`.`SK_VENDEDOR` = `G`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_VERSION_VEHICULO` as `H`  ON (`A`.`SK_VERSION_VEHICULO` = `H`.`SK_VERSION_VEHICULO`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) LEFT  JOIN `DIM_CLIENTE` as `K`  ON (`A`.`SK_CLIENTE` = `K`.`SK_CLIENTE`)) LEFT  JOIN `DIM_TIPO_FINANCIACION` as `L`  ON (`A`.`SK_TIPO_FINANCIACION` = `L`.`SK_TIPO_FINANCIACION`));

DROP VIEW VW_COACHING;
CREATE VIEW DWH.VW_COACHING AS
SELECT  
-- ROWNUMBER,
ANIO,
MES,
LINEA_NEGOCIO,
AGENCIA,
COD_USUARIO,
NOMBRE_VENDEDOR AS ASESOR,
VEHICULO_INTERES AS MODELO,
FAMILIA_VEHICULO_INTERES AS FAMILIA,
TIPO_VEHICULO_INTERES AS TIPO_VEHICULO ,
ESTADO_COACHING,
MOTIVO_CIERRE,
MOTIVO_OTRO,
COMENTARIO_COACH,
COMENTARIO_ASESOR,
COMENTARIO_COORDINADOR,
FECHA_CREACION_COACHING,
FECHA_MODIFICACION_COACHING,
FECHA_AGENDAMIENTO_COACHING,
TRAFICO,
COACHING,
CEDULA AS IDENTIFICACION,
DAYNAME(FECHA_CREACION) DIA_TRAFICO,
FECHA_CREACION AS FECHA_TRAFICO,
DAYNAME(FECHA_COACHING) DIA_COACHING,
FECHA_COACHING,
HOUR(FECHA_COACHING) HORA_COACHING,
TIMESTAMPDIFF(DAY,DATE(FECHA_CREACION),DATE(FECHA_COACHING)) DIFF,
 CASE WHEN COACHING = 'NO DEFINIDO' THEN 0
WHEN TIMESTAMPDIFF(DAY,DATE(FECHA_CREACION),DATE(FECHA_COACHING)) > 3 THEN 0
WHEN DAYNAME(FECHA_CREACION) IN ('Friday','Saturday','Sunday') AND DAYNAME(FECHA_COACHING) = 'Monday' AND TIMESTAMPDIFF(DAY,DATE(FECHA_CREACION),DATE(FECHA_COACHING)) <= 3 THEN 1
WHEN DAYNAME(FECHA_CREACION) = 'Friday' AND TIMESTAMPDIFF(DAY,DATE(FECHA_CREACION),DATE(FECHA_COACHING)) <= 3 THEN 1
WHEN TIMESTAMPDIFF(DAY,DATE(FECHA_CREACION),DATE(FECHA_COACHING)) <= 1 THEN 1 ELSE
0 END AS NUM_COACHING
FROM (
SELECT  
YEAR(T.FECHA_CREACION) AS ANIO,
MONTH(T.FECHA_CREACION) AS MES,
CAST(T.FECHA_CREACION as DATE) AS FECHA,
T.FECHA_CREACION,
C.CEDULA,
L.LINEA_NEGOCIO,
TR.TRAFICO,
A.AGENCIA,
VE.COD_USUARIO,
VE.NOMBRE_VENDEDOR,
V.VEHICULO_INTERES,
V.FAMILIA_VEHICULO_INTERES,
V.TIPO_VEHICULO_INTERES,
HC.COACHING,
HC.FECHA_COACHING,
EC.ESTADO_COACHING,
MC.MOTIVO_CIERRE,
HC.MOTIVO_OTRO,
HC.COMENTARIO_COACH,
HC.COMENTARIO_ASESOR,
HC.COMENTARIO_COORDINADOR,
HC.FECHA_CREACION FECHA_CREACION_COACHING,
HC.FECHA_MODIFICACION FECHA_MODIFICACION_COACHING,
HC.FECHA_AGENDAMIENTO FECHA_AGENDAMIENTO_COACHING,
ROW_NUMBER() OVER(PARTITION BY  TR.IDENTIFICACION,L.LINEA_NEGOCIO,TR.TRAFICO  ORDER BY T.FECHA_CREACION, HC.FECHA_COACHING,HC.COACHING) AS ROWNUMBER
FROM DWH.FC_TRAFICO T
INNER JOIN DWH.DIM_TRAFICO TR ON T.SK_TRAFICO = TR.SK_TRAFICO ;


DROP VIEW VW_ENCUESTA_COMPROMISO;
CREATE  VIEW `VW_ENCUESTA_COMPROMISO` AS SELECT `H`.`EMPRESA` AS `EMPRESA`, `A`.`SK_COLABORADOR` AS `COLABORADOR`, TIMESTAMPDIFF(YEAR, `A`.`FECHA_INGRESO`, CURDATE()) AS `ANIOS_SERVICIO`, TIMESTAMPDIFF(YEAR, `A`.`FECHA_NACIMIENTO`, CURDATE()) AS `EDAD`, `C`.`FACTOR` AS `FACTOR`, `I`.`PERIODO` AS `PERIODO`,  CASE `A`.`SEXO` WHEN 'F' THEN 'FEMENINO' WHEN 'M' THEN 'MASCULINO' ELSE NULL END  AS `SEXO`, `A`.`AREA` AS `AREA`, `A`.`DEPARTAMENTO` AS `DEPARTAMENTO`, `A`.`DIVISION` AS `DIVISION`, `A`.`SECCION` AS `SECCION`, `A`.`CARGO` AS `CARGO`, `A`.`JEFE` AS `JEFE`, `F`.`NOMBRE_PREGUNTA` AS `NOMBRE_PREGUNTA`, `G`.`RESPUESTA` AS `RESPUESTA`, `G`.`SUGERENCIA` AS `SUGERENCIA`, `A`.`CIUDAD` AS `CIUDAD` FROM ((((((`DIM_EC_COLABORADOR` as `A`  LEFT  JOIN `FC_ENCUESTA_COMPROMISO` as `B`  ON (`A`.`SK_COLABORADOR` = `B`.`SK_COLABORADOR`)) LEFT  JOIN `DIM_EC_FACTOR` as `C`  ON (`B`.`SK_FACTOR` = `C`.`SK_FACTOR`)) LEFT  JOIN `DIM_EC_PREGUNTA` as `F`  ON (`B`.`SK_PREGUNTA` = `F`.`SK_PREGUNTA`)) LEFT  JOIN `DIM_EC_RESPUESTA` as `G`  ON (`B`.`SK_RESPUESTA` = `G`.`SK_RESPUESTA`)) LEFT  JOIN `DIM_EMPRESA` as `H`  ON (`A`.`COD_EMPRESA` = `H`.`COD_EMPRESA`)) LEFT  JOIN `DIM_EC_PERIODO` as `I`  ON (`A`.`COD_PERIODO` = `I`.`COD_PERIODO`)) WHERE (`A`.`SK_COLABORADOR` <> 1);

DROP VIEW VW_ENCUESTA_COMPROMISO_MANSUERA;
CREATE  VIEW `VW_ENCUESTA_COMPROMISO_MANSUERA` AS SELECT `H`.`EMPRESA` AS `EMPRESA`, `A`.`SK_COLABORADOR` AS `COLABORADOR`, TIMESTAMPDIFF(YEAR, `A`.`FECHA_INGRESO`, CURDATE()) AS `ANIOS_SERVICIO`, TIMESTAMPDIFF(YEAR, `A`.`FECHA_NACIMIENTO`, CURDATE()) AS `EDAD`, `C`.`FACTOR` AS `FACTOR`, `I`.`PERIODO` AS `PERIODO`,  CASE `A`.`SEXO` WHEN 'F' THEN 'FEMENINO' WHEN 'M' THEN 'MASCULINO' ELSE NULL END  AS `SEXO`, `A`.`AREA` AS `AREA`, `A`.`DEPARTAMENTO` AS `DEPARTAMENTO`, `A`.`DIVISION` AS `DIVISION`, `A`.`SECCION` AS `SECCION`, `A`.`CARGO` AS `CARGO`, `A`.`JEFE` AS `JEFE`, `F`.`NOMBRE_PREGUNTA` AS `NOMBRE_PREGUNTA`, `G`.`RESPUESTA` AS `RESPUESTA`, `G`.`SUGERENCIA` AS `SUGERENCIA`, `A`.`CIUDAD` AS `CIUDAD` FROM ((((((`DIM_EC_COLABORADOR` as `A`  LEFT  JOIN `FC_ENCUESTA_COMPROMISO` as `B`  ON (`A`.`SK_COLABORADOR` = `B`.`SK_COLABORADOR`)) LEFT  JOIN `DIM_EC_FACTOR` as `C`  ON (`B`.`SK_FACTOR` = `C`.`SK_FACTOR`)) LEFT  JOIN `DIM_EC_PREGUNTA` as `F`  ON (`B`.`SK_PREGUNTA` = `F`.`SK_PREGUNTA`)) LEFT  JOIN `DIM_EC_RESPUESTA` as `G`  ON (`B`.`SK_RESPUESTA` = `G`.`SK_RESPUESTA`)) LEFT  JOIN `DIM_EMPRESA` as `H`  ON (`A`.`COD_EMPRESA` = `H`.`COD_EMPRESA`)) LEFT  JOIN `DIM_EC_PERIODO` as `I`  ON (`A`.`COD_PERIODO` = `I`.`COD_PERIODO`)) WHERE ((`A`.`SK_COLABORADOR` <> 1) AND (`A`.`COD_EMPRESA` = '10') AND (`A`.`COD_PERIODO` = '10'));

DROP VIEW VW_NPS;
CREATE  VIEW `VW_NPS` AS SELECT `B`.`EMPRESA` AS `EMPRESA`, `C`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `D`.`AGENCIA` AS `AGENCIA`, `E`.`ESTADO` AS `ESTADO`, `F`.`CALL_CENTER` AS `CALL_CENTER`,  CASE  WHEN (`G`.`SK_TECNICO_ASESOR` = 1) THEN `H`.`NOMBRE_VENDEDOR` ELSE `G`.`TECNICO_ASESOR` END  AS `ASESOR`, `I`.`FECHA` AS `FECHA_CREACION`, `I`.`FECHA` AS `FECHA_ENVIO`, `J`.`FECHA` AS `FECHA_RESPUESTA`, `L`.`NOMBRE` AS `NOMBRE`, `L`.`TELEFONO` AS `TELEFONO`, `L`.`TELEFONO2` AS `TELEFONO2`, `L`.`EMAIL1` AS `EMAIL1`, `L`.`EMAIL2` AS `EMAIL2`, `A`.`CALIFICACION` AS `CALIFICACION`, `M`.`COMENTARIO` AS `COMENTARIO`, `A`.`NUMERO_FACTURA` AS `NUMERO_FACTURA` FROM ((((((((((((`FC_NPS` as `A`  LEFT  JOIN `DIM_EMPRESA` as `B`  ON (`A`.`SK_EMPRESA` = `B`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `C`  ON (`A`.`SK_LINEA_NEGOCIO` = `C`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `D`  ON (`A`.`SK_AGENCIA` = `D`.`SK_AGENCIA`)) LEFT  JOIN `DIM_NPS_ESTADO` as `E`  ON (`A`.`SK_ESTADO` = `E`.`SK_ESTADO`)) LEFT  JOIN `DIM_NPS_CALLCENTER` as `F`  ON (`F`.`SK_CALLCENTER` = `A`.`SK_CALLCENTER`)) LEFT  JOIN `DIM_TECNICO_ASESOR` as `G`  ON (`A`.`SK_TECNICO_ASESOR` = `G`.`SK_TECNICO_ASESOR`)) LEFT  JOIN `DIM_VENDEDOR` as `H`  ON (`H`.`SK_VENDEDOR` = `A`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_FECHA` as `I`  ON (`A`.`SK_FECHA` = `I`.`SK_FECHA`)) LEFT  JOIN `DIM_FECHA` as `J`  ON (`A`.`SK_FECHA_ENVIO` = `J`.`SK_FECHA`)) LEFT  JOIN `DIM_FECHA` as `K`  ON (`A`.`SK_FECHA_RESPUESTA` = `K`.`SK_FECHA`)) LEFT  JOIN `DIM_CLIENTE` as `L`  ON (`A`.`SK_CLIENTE` = `L`.`SK_CLIENTE`)) LEFT  JOIN `DIM_NPS_COMENTARIO` as `M`  ON (`A`.`SK_COMENTARIO` = `M`.`SK_COMENTARIO`));

DROP VIEW VW_TRAFICO_PERSONAS;
CREATE VIEW `VW_TRAFICO_PERSONAS` AS SELECT DISTINCT `SUB`.`ANIO` AS `ANIO`, `SUB`.`MES` AS `MES`, `SUB`.`FECHA` AS `FECHA`, `SUB`.`IDENTIFICACION` AS `IDENTIFICACION`, `SUB`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `SUB`.`TRAFICO` AS `TRAFICO`, `SUB`.`AGENCIA` AS `AGENCIA`, `SUB`.`COD_USUARIO` AS `COD_USUARIO`, `SUB`.`ASESOR` AS `ASESOR`, `SUB`.`MODELO` AS `MODELO`, `SUB`.`FAMILIA` AS `FAMILIA`, `SUB`.`TIPO_VEHICULO` AS `TIPO_VEHICULO`, `SUB`.`COACHING` AS `COACHING`, `SUB`.`FECHA_COACHING` AS `FECHA_COACHING`, `SUB`.`ESTADO_COACHING` AS `ESTADO_COACHING`, `SUB`.`MOTIVO_CIERRE` AS `MOTIVO_CIERRE`, `SUB`.`MOTIVO_OTRO` AS `MOTIVO_OTRO`, `SUB`.`COMENTARIO_COACH` AS `COMENTARIO_COACH`, `SUB`.`COMENTARIO_ASESOR` AS `COMENTARIO_ASESOR`, `SUB`.`COMENTARIO_COORDINADOR` AS `COMENTARIO_COORDINADOR`, `SUB`.`FECHA_CREACION_COACHING` AS `FECHA_CREACION_COACHING`, `SUB`.`FECHA_MODIFICACION_COACHING` AS `FECHA_MODIFICACION_COACHING`, `SUB`.`FECHA_AGENDAMIENTO_COACHING` AS `FECHA_AGENDAMIENTO_COACHING` FROM  ( SELECT `A`.`ANIO` AS `ANIO`, `A`.`MES` AS `MES`, `A`.`FECHA` AS `FECHA`, `A`.`CEDULA` AS `IDENTIFICACION`, `A`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `A`.`TRAFICO` AS `TRAFICO`, `A`.`AGENCIA` AS `AGENCIA`, `A`.`COD_USUARIO` AS `COD_USUARIO`, `A`.`NOMBRE_VENDEDOR` AS `ASESOR`, `A`.`VEHICULO_INTERES` AS `MODELO`, `A`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA`, `A`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO`, `A`.`COACHING` AS `COACHING`, `A`.`FECHA_COACHING` AS `FECHA_COACHING`, `A`.`ESTADO_COACHING` AS `ESTADO_COACHING`, `A`.`MOTIVO_CIERRE` AS `MOTIVO_CIERRE`, `A`.`MOTIVO_OTRO` AS `MOTIVO_OTRO`, `A`.`COMENTARIO_COACH` AS `COMENTARIO_COACH`, `A`.`COMENTARIO_ASESOR` AS `COMENTARIO_ASESOR`, `A`.`COMENTARIO_COORDINADOR` AS `COMENTARIO_COORDINADOR`, `A`.`FECHA_CREACION_COACHING` AS `FECHA_CREACION_COACHING`, `A`.`FECHA_MODIFICACION_COACHING` AS `FECHA_MODIFICACION_COACHING`, `A`.`FECHA_AGENDAMIENTO_COACHING` AS `FECHA_AGENDAMIENTO_COACHING` FROM  ( SELECT  YEAR(`T`.`FECHA_CREACION`) AS `ANIO`,  MONTH(`T`.`FECHA_CREACION`) AS `MES`,  DATE(`T`.`FECHA_CREACION`) AS `FECHA`, `T`.`FECHA_CREACION` AS `FECHA_CREACION`, `C`.`CEDULA` AS `CEDULA`, `L`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `TR`.`TRAFICO` AS `TRAFICO`, `A`.`AGENCIA` AS `AGENCIA`, `VE`.`COD_USUARIO` AS `COD_USUARIO`, `VE`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `V`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `V`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES`, `V`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO_INTERES`, `HC`.`COACHING` AS `COACHING`, `HC`.`FECHA_COACHING` AS `FECHA_COACHING`, `EC`.`ESTADO_COACHING` AS `ESTADO_COACHING`, `MC`.`MOTIVO_CIERRE` AS `MOTIVO_CIERRE`, `HC`.`MOTIVO_OTRO` AS `MOTIVO_OTRO`, `HC`.`COMENTARIO_COACH` AS `COMENTARIO_COACH`, `HC`.`COMENTARIO_ASESOR` AS `COMENTARIO_ASESOR`, `HC`.`COMENTARIO_COORDINADOR` AS `COMENTARIO_COORDINADOR`, `HC`.`FECHA_CREACION` AS `FECHA_CREACION_COACHING`, `HC`.`FECHA_MODIFICACION` AS `FECHA_MODIFICACION_COACHING`, `HC`.`FECHA_AGENDAMIENTO` AS `FECHA_AGENDAMIENTO_COACHING`,  ROW_NUMBER() OVER (PARTITION BY  MONTH(`T`.`FECHA_CREACION`),  YEAR(`T`.`FECHA_CREACION`), `L`.`LINEA_NEGOCIO`, `TR`.`IDENTIFICACION` ORDER BY  MONTH(`T`.`FECHA_CREACION`), `T`.`FECHA_CREACION`, `HC`.`FECHA_COACHING`) AS `ROWNUMBER` FROM (((((((((`FC_TRAFICO` as `T`  JOIN `DIM_TRAFICO` as `TR`  ON (`T`.`SK_TRAFICO` = `TR`.`SK_TRAFICO`)) JOIN `DIM_CONTACTO` as `C`  ON (`T`.`SK_CONTACTO` = `C`.`SK_CONTACTO`)) JOIN `DIM_LINEA_NEGOCIO` as `L`  ON (`T`.`SK_LINEA_NEGOCIO` = `L`.`SK_LINEA_NEGOCIO`)) JOIN `DIM_VEHICULOS_INTERES` as `V`  ON (`T`.`SK_VEHICULO_INTERES` = `V`.`SK_VEHICULO_INTERES`)) JOIN `DIM_AGENCIA` as `A`  ON (`T`.`SK_AGENCIA` = `A`.`SK_AGENCIA`)) JOIN `DIM_VENDEDOR` as `VE`  ON (`T`.`SK_VENDEDOR` = `VE`.`SK_VENDEDOR`)) JOIN `DIM_HISTORIAL_COACHING` as `HC`  ON (`T`.`SK_HISTORIAL_COACHING` = `HC`.`SK_HISTORIAL_COACHING`)) JOIN `DIM_ESTADO_COACHING` as `EC`  ON (`T`.`SK_ESTADO_COACHING` = `EC`.`SK_ESTADO_COACHING`)) JOIN `DIM_MOTIVO_CIERRE` as `MC`  ON ((`T`.`SK_MOTIVO_CIERRE` = `MC`.`SK_MOTIVO_CIERRE`) AND (`T`.`SK_CONTACTO` <> 1))) ) AS `A` WHERE (`A`.`ROWNUMBER` = 1) UNION ALL SELECT `B`.`ANIO` AS `ANIO`, `B`.`MES` AS `MES`, `B`.`FECHA` AS `FECHA`, `B`.`CEDULA` AS `IDENTIFICACION`, `B`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `B`.`TRAFICO` AS `TRAFICO`, `B`.`AGENCIA` AS `AGENCIA`, `B`.`COD_USUARIO` AS `COD_USUARIO`, `B`.`NOMBRE_VENDEDOR` AS `ASESOR`, `B`.`VEHICULO_INTERES` AS `MODELO`, `B`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA`, `B`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO`, `B`.`COACHING` AS `COACHING`, `B`.`FECHA_COACHING` AS `FECHA_COACHING`, `B`.`ESTADO_COACHING` AS `ESTADO_COACHING`, `B`.`MOTIVO_CIERRE` AS `MOTIVO_CIERRE`, `B`.`MOTIVO_OTRO` AS `MOTIVO_OTRO`, `B`.`COMENTARIO_COACH` AS `COMENTARIO_COACH`, `B`.`COMENTARIO_ASESOR` AS `COMENTARIO_ASESOR`, `B`.`COMENTARIO_COORDINADOR` AS `COMENTARIO_COORDINADOR`, `B`.`FECHA_CREACION_COACHING` AS `FECHA_CREACION_COACHING`, `B`.`FECHA_MODIFICACION_COACHING` AS `FECHA_MODIFICACION_COACHING`, `B`.`FECHA_AGENDAMIENTO_COACHING` AS `FECHA_AGENDAMIENTO_COACHING` FROM  ( SELECT  YEAR(`T`.`FECHA_CREACION`) AS `ANIO`,  MONTH(`T`.`FECHA_CREACION`) AS `MES`,  DATE(`T`.`FECHA_CREACION`) AS `FECHA`, `T`.`FECHA_CREACION` AS `FECHA_CREACION`, `TR`.`IDENTIFICACION` AS `CEDULA`, `L`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `TR`.`TRAFICO` AS `TRAFICO`, `A`.`AGENCIA` AS `AGENCIA`, `VE`.`COD_USUARIO` AS `COD_USUARIO`, `VE`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `V`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `V`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES`, `V`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO_INTERES`, `HC`.`COACHING` AS `COACHING`, `HC`.`FECHA_COACHING` AS `FECHA_COACHING`, `EC`.`ESTADO_COACHING` AS `ESTADO_COACHING`, `MC`.`MOTIVO_CIERRE` AS `MOTIVO_CIERRE`, `HC`.`MOTIVO_OTRO` AS `MOTIVO_OTRO`, `HC`.`COMENTARIO_COACH` AS `COMENTARIO_COACH`, `HC`.`COMENTARIO_ASESOR` AS `COMENTARIO_ASESOR`, `HC`.`COMENTARIO_COORDINADOR` AS `COMENTARIO_COORDINADOR`, `HC`.`FECHA_CREACION` AS `FECHA_CREACION_COACHING`, `HC`.`FECHA_MODIFICACION` AS `FECHA_MODIFICACION_COACHING`, `HC`.`FECHA_AGENDAMIENTO` AS `FECHA_AGENDAMIENTO_COACHING`,  ROW_NUMBER() OVER (PARTITION BY  MONTH(`T`.`FECHA_CREACION`),  YEAR(`T`.`FECHA_CREACION`), `L`.`LINEA_NEGOCIO`, `TR`.`IDENTIFICACION` ORDER BY  MONTH(`T`.`FECHA_CREACION`), `T`.`FECHA_CREACION`, `HC`.`FECHA_COACHING`) AS `ROWNUMBER` FROM (((((((((`FC_TRAFICO` as `T`  JOIN `DIM_TRAFICO` as `TR`  ON (`T`.`SK_TRAFICO` = `TR`.`SK_TRAFICO`)) JOIN `DIM_CONTACTO` as `C`  ON (`T`.`SK_CONTACTO` = `C`.`SK_CONTACTO`)) JOIN `DIM_LINEA_NEGOCIO` as `L`  ON (`T`.`SK_LINEA_NEGOCIO` = `L`.`SK_LINEA_NEGOCIO`)) JOIN `DIM_VEHICULOS_INTERES` as `V`  ON (`T`.`SK_VEHICULO_INTERES` = `V`.`SK_VEHICULO_INTERES`)) JOIN `DIM_AGENCIA` as `A`  ON (`T`.`SK_AGENCIA` = `A`.`SK_AGENCIA`)) JOIN `DIM_VENDEDOR` as `VE`  ON (`T`.`SK_VENDEDOR` = `VE`.`SK_VENDEDOR`)) JOIN `DIM_HISTORIAL_COACHING` as `HC`  ON (`T`.`SK_HISTORIAL_COACHING` = `HC`.`SK_HISTORIAL_COACHING`)) JOIN `DIM_ESTADO_COACHING` as `EC`  ON (`T`.`SK_ESTADO_COACHING` = `EC`.`SK_ESTADO_COACHING`)) JOIN `DIM_MOTIVO_CIERRE` as `MC`  ON ((`T`.`SK_MOTIVO_CIERRE` = `MC`.`SK_MOTIVO_CIERRE`) AND (`T`.`SK_CONTACTO` = 1))) ) AS `B` WHERE (`B`.`ROWNUMBER` = 1) ) AS `SUB`;
SHOW CREATE PROCEDURE CRG_CAT_TIPO_EXONERADO;
SHOW PROCEDURES ;

SHOW CREATE TABLE DWH.DIM_TIPO_EXONERADO;

SELECT * FROM DWH.DIM_TIPO_EXONERADO ;
