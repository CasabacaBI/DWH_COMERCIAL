-- Vistas 

drop VIEW VW_CIERRE_NUEVOS ;

CREATE DEFINER=`root`@`%` VIEW `VW_CIERRE_NUEVOS` AS 
SELECT DISTINCT `SUB`.`ANIO` AS `ANIO`, `SUB`.`MES` AS `MES`, `SUB`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `SUB`.`AGENCIA` AS `AGENCIA`, `SUB`.`COD_USUARIO` AS `COD_USUARIO`, `SUB`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `SUB`.`MODELO` AS `MODELO`, `SUB`.`FAMILIA` AS `FAMILIA`, `SUB`.`TIPO` AS `TIPO`, `SUB`.`VALOR` AS `VALOR` FROM  ( SELECT ``.`ANIO` AS `ANIO`, ``.`MES` AS `MES`, ``.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, ``.`AGENCIA` AS `AGENCIA`, ``.`COD_USUARIO` AS `COD_USUARIO`, ``.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, ``.`MODELO` AS `MODELO`, ``.`FAMILIA` AS `FAMILIA`, ``.`TIPO` AS `TIPO`, ``.`VALOR` AS `VALOR` FROM  ( SELECT `A`.`ANIO` AS `ANIO`, `A`.`MES` AS `MES`, `A`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `A`.`AGENCIA` AS `AGENCIA`, `A`.`COD_USUARIO` AS `COD_USUARIO`, `A`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `A`.`VEHICULO_INTERES` AS `MODELO`, `A`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA`, 'TRAFICO' AS `TIPO`, SUM( CASE  WHEN (`A`.`RANKING` = 1) THEN 1 ELSE 0 END ) AS `VALOR` FROM  ( SELECT  YEAR(`T`.`FECHA_CREACION`) AS `ANIO`,  MONTH(`T`.`FECHA_CREACION`) AS `MES`,  DATE(`T`.`FECHA_CREACION`) AS `FECHA`, `T`.`FECHA_CREACION` AS `FECHA_CREACION`, `L`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `TR`.`TRAFICO` AS `TRAFICO`, `A`.`AGENCIA` AS `AGENCIA`, `VE`.`COD_USUARIO` AS `COD_USUARIO`, `VE`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `V`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `V`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES`, `V`.`TIPO_VEHICULO_INTERES` AS `TIPO_VEHICULO_INTERES`,  ROW_NUMBER() OVER (PARTITION BY  MONTH(`T`.`FECHA_CREACION`),  YEAR(`T`.`FECHA_CREACION`), `L`.`LINEA_NEGOCIO`, `TR`.`IDENTIFICACION`, `VE`.`COD_USUARIO` ORDER BY  MONTH(`T`.`FECHA_CREACION`), `T`.`FECHA_CREACION`) AS `RANKING` FROM (((((`FC_TRAFICO` as `T`  JOIN `DIM_TRAFICO` as `TR`  ON (`T`.`SK_TRAFICO` = `TR`.`SK_TRAFICO`)) JOIN `DIM_LINEA_NEGOCIO` as `L`  ON (`T`.`SK_LINEA_NEGOCIO` = `L`.`SK_LINEA_NEGOCIO`)) JOIN `DIM_VEHICULOS_INTERES` as `V`  ON (`T`.`SK_VEHICULO_INTERES` = `V`.`SK_VEHICULO_INTERES`)) JOIN `DIM_AGENCIA` as `A`  ON (`T`.`SK_AGENCIA` = `A`.`SK_AGENCIA`)) JOIN `DIM_VENDEDOR` as `VE`  ON (`T`.`SK_VENDEDOR` = `VE`.`SK_VENDEDOR`)) WHERE (`L`.`COD_LINEA_NEGOCIO` = '3') ) AS `A` GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9 HAVING (`A`.`ANIO` > 2018) ) AS `` UNION ALL SELECT ``.`ANIO` AS `ANIO`, ``.`MES` AS `MES`, ``.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, ``.`AGENCIA` AS `AGENCIA`, ``.`COD_USUARIO` AS `COD_USUARIO`, ``.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, ``.`MODELO` AS `MODELO`, ``.`FAMILIA` AS `FAMILIA`, ``.`TIPO` AS `TIPO`, ``.`VALOR` AS `VALOR` FROM  ( SELECT `AA`.`ANIO` AS `ANIO`, `AA`.`MES` AS `MES`, `AA`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `AA`.`AGENCIA` AS `AGENCIA`, `AA`.`COD_USUARIO` AS `COD_USUARIO`, `AA`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `AA`.`MODELO` AS `MODELO`,  IFNULL(`K`.`FAMILIA_VEHICULO_INTERES`,'NO DEFINIDO') AS `FAMILIA`, 'VENTA' AS `TIPO`, `AA`.`VALOR` AS `VALOR` FROM ( ( SELECT  YEAR(`B`.`FECHA`) AS `ANIO`,  MONTH(`B`.`FECHA`) AS `MES`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`AGENCIA` AS `AGENCIA`, `G`.`COD_USUARIO` AS `COD_USUARIO`, `G`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `J`.`MODELO` AS `MODELO`, SUM( CASE  WHEN (`F`.`COD_TIPO_DOCUMENTO` = 'FD') THEN -1 ELSE 1 END ) AS `VALOR` FROM ((((((((`FC_VENTAS_NUEVOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `F`  ON (`A`.`SK_TIPO_DOCUMENTO` = `F`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VENDEDOR` as `G`  ON (`A`.`SK_VENDEDOR` = `G`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) GROUP BY 1, 2, 3, 4, 5, 6, 7 HAVING ( YEAR(`B`.`FECHA`) > 2018) ) AS `AA` LEFT  JOIN  ( SELECT DISTINCT `dvi`.`VEHICULO_INTERES` AS `VEHICULO_INTERES`, `dvi`.`FAMILIA_VEHICULO_INTERES` AS `FAMILIA_VEHICULO_INTERES` FROM `DIM_VEHICULOS_INTERES` as `dvi`  ) AS `K` ON (`K`.`VEHICULO_INTERES` = `AA`.`MODELO`)) ) AS `` ) AS `SUB`;

DROP VIEW VW_VEHICULOS_EXONERADOS;
CREATE DEFINER=`root`@`%` VIEW `VW_VEHICULOS_EXONERADOS` AS SELECT `B`.`FECHA` AS `FECHA`, `C`.`EMPRESA` AS `EMPRESA`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`AGENCIA` AS `AGENCIA`, `F`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `G`.`TIPO_DOCUMENTO` AS `TIPO_DOCUMENTO`, `G`.`COD_TIPO_DOCUMENTO` AS `COD_TIPO_DOCUMENTO`, `H`.`VERSION_VEHICULO` AS `VERSION_VEHICULO`, `I`.`FORMA_PAGO` AS `FORMA_PAGO`, `A`.`SK_FACTURA` AS `SK_FACTURA`, `A`.`SK_COTIZACION` AS `SK_COTIZACION`, `A`.`SK_NO_FISICO` AS `SK_NO_FISICO`, `J`.`CHASIS` AS `CHASIS`, `J`.`MODELO` AS `MODELO`, `K`.`CEDULA` AS `CEDULA`, `M`.`TIPO_EXONERADO` AS `TIPO_EXONERADO`, `A`.`PORCENTAJE_DISCAPACIDAD` AS `PORCENTAJE_DISCAPACIDAD`, `L`.`TIPO_FINANCIACION` AS `TIPO_FINANCIACION`, `L`.`COD_TIPO_FINANCIACION` AS `COD_TIPO_FINANCIACION`, `A`.`COSTO_VEHICULO` AS `COSTO_VEHICULO`, `A`.`PRECIO` AS `PRECIO`, `A`.`SALDO_FINANCIAR` AS `SALDO_FINANCIAR`, `A`.`CUOTA_DE_ALCANCE` AS `CUOTA_DE_ALCANCE`, `A`.`COSTOS_IMPORT` AS `COSTOS_IMPORT`, `A`.`COMISON_SIN_IVA` AS `COMISON_SIN_IVA`, `A`.`COMISION_CON_IVA` AS `COMISION_CON_IVA` FROM ((((((((((((`FC_VENTAS_EXONERADOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_VENDEDOR` as `F`  ON (`A`.`SK_VENDEDOR` = `F`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `G`  ON (`A`.`SK_TIPO_DOCUMENTO` = `G`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VERSION_VEHICULO` as `H`  ON (`A`.`SK_VERSION_VEHICULO` = `H`.`SK_VERSION_VEHICULO`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) LEFT  JOIN `DIM_CLIENTE` as `K`  ON (`A`.`SK_CLIENTE` = `K`.`SK_CLIENTE`)) LEFT  JOIN `DIM_TIPO_FINANCIACION` as `L`  ON (`A`.`SK_TIPO_FINANCIACION` = `L`.`SK_TIPO_FINANCIACION`)) LEFT  JOIN `DIM_TIPO_EXONERADO` as `M`  ON (`A`.`SK_TIPO_EXONERADO` = `M`.`SK_TIPO_EXONERADO`));

DROP VIEW VW_VEHICULOS_NUEVOS ;
CREATE DEFINER=`root`@`%` VIEW `VW_VEHICULOS_NUEVOS` AS SELECT `B`.`FECHA` AS `FECHA`, `C`.`COD_EMPRESA` AS `COD_EMPRESA`, `C`.`EMPRESA` AS `EMPRESA`, `D`.`COD_LINEA_NEGOCIO` AS `COD_LINEA_NEGOCIO`, `D`.`LINEA_NEGOCIO` AS `LINEA_NEGOCIO`, `E`.`COD_AGENCIA` AS `COD_AGENCIA`, `E`.`AGENCIA` AS `AGENCIA`, `F`.`COD_TIPO_DOCUMENTO` AS `COD_TIPO_DOCUMENTO`, `F`.`TIPO_DOCUMENTO` AS `TIPO_DOCUMENTO`, `G`.`COD_USUARIO` AS `COD_USUARIO`, `G`.`NOMBRE_VENDEDOR` AS `NOMBRE_VENDEDOR`, `H`.`COD_VERSION_VEHICULO` AS `COD_VERSION_VEHICULO`, `H`.`VERSION_VEHICULO` AS `VERSION_VEHICULO`, `I`.`FORMA_PAGO` AS `FORMA_PAGO`, `J`.`CHASIS` AS `CHASIS`, `J`.`MARCA` AS `MARCA`, `J`.`MODELO` AS `MODELO`, `J`.`PLACA` AS `PLACA`, `J`.`SFX` AS `SFX`, `J`.`ANIO_VEHICULO` AS `ANIO_VEHICULO`, `K`.`NOMBRE` AS `NOMBRE`, `K`.`CEDULA` AS `CEDULA`, `K`.`PROVINCIA` AS `PROVINCIA`, `K`.`SEXO` AS `SEXO`, `K`.`TELEFONO` AS `TELEFONO`, `K`.`TELEFONO2` AS `TELEFONO2`, `K`.`TIPO_CLIENTE` AS `TIPO_CLIENTE`, `L`.`COD_TIPO_FINANCIACION` AS `COD_TIPO_FINANCIACION`, `L`.`TIPO_FINANCIACION` AS `TIPO_FINANCIACION`, `A`.`COSTO_VEHICULO` AS `COSTO_VEHICULO`, `A`.`DESCUENTO` AS `DESCUENTO`, `A`.`PRECIO` AS `PRECIO`, `A`.`SUBTOTAL_MASIVO` AS `SUBTOTAL_MASIVO`, `A`.`VALOR_NETO` AS `VALOR_NETO`, `A`.`SALDO_FINANCIAR` AS `SALDO_FINANCIAR`, `A`.`COUTA_DE_ALCANCE` AS `COUTA_DE_ALCANCE`, `A`.`UTILIDAD` AS `UTILIDAD`, `A`.`SK_FACTURA` AS `NRO_FACTURA`, `A`.`SK_COTIZACION` AS `NRO_COTIZACION`, `A`.`SK_NO_FISICO` AS `NRO_FISICO` FROM (((((((((((`FC_VENTAS_NUEVOS` as `A`  LEFT  JOIN `DIM_FECHA` as `B`  ON (`A`.`SK_FECHA_FACTURA` = `B`.`SK_FECHA`)) LEFT  JOIN `DIM_EMPRESA` as `C`  ON (`A`.`SK_EMPRESA` = `C`.`SK_EMPRESA`)) LEFT  JOIN `DIM_LINEA_NEGOCIO` as `D`  ON (`A`.`SK_LINEA_NEGOCIO` = `D`.`SK_LINEA_NEGOCIO`)) LEFT  JOIN `DIM_AGENCIA` as `E`  ON (`A`.`SK_AGENCIA` = `E`.`SK_AGENCIA`)) LEFT  JOIN `DIM_TIPO_DOCUMENTO` as `F`  ON (`A`.`SK_TIPO_DOCUMENTO` = `F`.`SK_TIPO_DOCUMENTO`)) LEFT  JOIN `DIM_VENDEDOR` as `G`  ON (`A`.`SK_VENDEDOR` = `G`.`SK_VENDEDOR`)) LEFT  JOIN `DIM_VERSION_VEHICULO` as `H`  ON (`A`.`SK_VERSION_VEHICULO` = `H`.`SK_VERSION_VEHICULO`)) LEFT  JOIN `DIM_FORMA_PAGO` as `I`  ON (`A`.`SK_FORMA_PAGO` = `I`.`SK_FORMA_PAGO`)) LEFT  JOIN `DIM_VEHICULO` as `J`  ON (`A`.`SK_VEHICULO` = `J`.`SK_VEHICULO`)) LEFT  JOIN `DIM_CLIENTE` as `K`  ON (`A`.`SK_CLIENTE` = `K`.`SK_CLIENTE`)) LEFT  JOIN `DIM_TIPO_FINANCIACION` as `L`  ON (`A`.`SK_TIPO_FINANCIACION` = `L`.`SK_TIPO_FINANCIACION`));


SHOW CREATE TABLE VW_COACHING ;

SHOW 