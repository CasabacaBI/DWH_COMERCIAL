CREATE OR REPLACE PROCEDURE `CRG_DIM_TRAFICO`(VAR_SCHEMA varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL) RETURNS void AS
/***********************************************************************************************************************
  * Descripcion: Cargar Datos DIM_TRAFICO
  * Version: 1.0.0
  * Fecha Creacion: 03/02/2020
  * Autor: Ivan Suasnavas
  * Comentario : Para Ejecutar = CALL CRG_DIM_TRAFICO('SQUEMA')
  -------------------------------------------------------------------------
  * Fecha Modificacion:
  * Modificado:
*************************************************************************************************************************/
DECLARE
	VAR_SQL VARCHAR(4000);
	VAR_ERROR VARCHAR(4000);
	VAR_DT_INICIO TIMESTAMP = CURRENT_TIMESTAMP;
BEGIN
START TRANSACTION;
	INSERT INTO CTR.LOG_PROCESO (MODULO, ETAPA,DT_FECHA_INICIO) VALUES ('DIMENSION',CONCAT('INICIO ',VAR_SCHEMA,'.CRG_DIM_TRAFICO'),VAR_DT_INICIO);
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_DM_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

-- GUARDA EN UNA TABLA TEMPORAL LOS REGISTROS ACTUALIZADOS
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_DM_TRAFICO
	SELECT  R.SK_TRAFICO,R.COD_TRAFICO,R.TRAFICO
	,IF(NVL(P.TIPO_IDENTIFICACION,R.TIPO_IDENTIFICACION)=R.TIPO_IDENTIFICACION,R.TIPO_IDENTIFICACION,P.TIPO_IDENTIFICACION) TIPO_IDENTIFICACION
	,IF(NVL(P.NUMERO_IDENTIFICACION,R.IDENTIFICACION)=R.IDENTIFICACION,R.IDENTIFICACION,P.NUMERO_IDENTIFICACION) IDENTIFICACION
	,IF(NVL(P.NOMBRES,R.NOMBRES)=R.NOMBRES,R.NOMBRES,P.NOMBRES) NOMBRES
	,IF(NVL(P.APELLIDOS,R.APELLIDOS)=R.APELLIDOS,R.APELLIDOS,P.APELLIDOS) APELLIDOS
	,IF(NVL(P.CELULAR,R.CELULAR)=R.CELULAR,R.CELULAR,P.CELULAR) CELULAR
	,IF(NVL(P.TELEFONO,R.TELEFONO)=R.TELEFONO,R.TELEFONO,P.TELEFONO) TELEFONO
	,IF(NVL(P.EMAIL,R.EMAIL)=R.EMAIL,R.EMAIL,P.EMAIL) EMAIL
	,IF(NVL(P.NOMBRES,R.NOMBRES)=R.NOMBRES,R.FECHA_CARGA,CURRENT_TIMESTAMP) FECHA_CARGA
	FROM DWH.DIM_TRAFICO R
	LEFT JOIN ',VAR_SCHEMA,'.CRM_CB_TRAFICOCONTROL P ON R.COD_TRAFICO = P.ID AND R.TRAFICO = P.NAME	
	WHERE P.NAME IS NOT NULL
	');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- ELIMINA LOS DATOS DE LA DIM
	VAR_SQL=CONCAT('TRUNCATE TABLE DWH.DIM_TRAFICO');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA LOS DATOS DE LA TMP1 A LA DIM
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_TRAFICO
	  (SK_TRAFICO, COD_TRAFICO, TRAFICO,TIPO_IDENTIFICACION, IDENTIFICACION, NOMBRES, APELLIDOS, CELULAR, TELEFONO, EMAIL, FECHA_CARGA)
          SELECT  SK_TRAFICO, COD_TRAFICO, TRAFICO,TIPO_IDENTIFICACION, IDENTIFICACION, NOMBRES, APELLIDOS, CELULAR, TELEFONO, EMAIL, FECHA_CARGA
	  FROM ',VAR_SCHEMA,'.TMP_DM_TRAFICO A');
	  EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_DM_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA TMP 
	VAR_SQL=CONCAT('CREATE TABLE DSA.TMP_DM_TRAFICO
		SELECT DISTINCT
			ID,NAME,TIPO_IDENTIFICACION,NUMERO_IDENTIFICACION, NOMBRES, APELLIDOS, CELULAR, TELEFONO, EMAIL
			FROM ',VAR_SCHEMA,'.CRM_CB_TRAFICOCONTROL A WHERE NAME IS NOT NULL AND DATE_ENTERED IS NOT NULL AND DATE_MODIFIED IS NOT NULL AND CREATED_BY IS NOT NULL
     ');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA DIM 
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_TRAFICO
		(COD_TRAFICO, TRAFICO,TIPO_IDENTIFICACION, IDENTIFICACION, NOMBRES, APELLIDOS, CELULAR, TELEFONO, EMAIL)
		SELECT A.ID,A.NAME,A.TIPO_IDENTIFICACION,A.NUMERO_IDENTIFICACION,A.NOMBRES,A.APELLIDOS,A.CELULAR,A.TELEFONO,A.EMAIL
		FROM DSA.TMP_DM_TRAFICO A
		LEFT JOIN DWH.DIM_TRAFICO B ON A.ID = B.COD_TRAFICO AND A.NAME = B.TRAFICO
		WHERE B.TIPO_IDENTIFICACION IS NULL and B.IDENTIFICACION IS NULL
		');
	 	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_DM_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

END;