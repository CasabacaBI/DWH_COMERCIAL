CREATE OR REPLACE PROCEDURE `CRG_DIM_VEHICULOS_INTERES`(VAR_SCHEMA varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL) RETURNS void AS
/***********************************************************************************************************************
  * Descripcion: Cargar Datos DIM_VEHICULOS_INTERES
  * Version: 1.0.0
  * Fecha Creacion: 21/01/2020
  * Autor: Ivan Suasnavas
  * Comentario : Para Ejecutar = CALL CRG_DIM_VEHICULOS_INTERES('SQUEMA')
  -------------------------------------------------------------------------
  * Fecha Modificacion:
  * Modificado:
*************************************************************************************************************************/
DECLARE
	VAR_SQL VARCHAR(4000);
	VAR_ERROR VARCHAR(4000);
	VAR_DT_INICIO TIMESTAMP = CURRENT_TIMESTAMP;
BEGIN
START TRANSACTION;
	INSERT INTO CTR.LOG_PROCESO (MODULO, ETAPA,DT_FECHA_INICIO) VALUES ('DIMENSION',CONCAT('INICIO ',VAR_SCHEMA,'.CRG_DIM_VEHICULOS_INTERES'),VAR_DT_INICIO);
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

-- GUARDA EN UNA TABLA TEMPORAL LOS REGISTROS ACTUALIZADOS
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES  
	SELECT  R.SK_VEHICULO_INTERES,R.COD_VEHICULO_INTERES
	,IF(NVL(P.NOMBRE,R.VEHICULO_INTERES)=R.VEHICULO_INTERES,R.VEHICULO_INTERES,P.NOMBRE) VEHICULO_INTERES
	,IF(NVL(P.FAMILIA,R.FAMILIA_VEHICULO_INTERES)=R.FAMILIA_VEHICULO_INTERES,R.FAMILIA_VEHICULO_INTERES,P.FAMILIA) FAMILIA_VEHICULO_INTERES
	,IF(NVL(P.TIPO,R.TIPO_VEHICULO_INTERES)=R.TIPO_VEHICULO_INTERES,R.TIPO_VEHICULO_INTERES,P.TIPO) TIPO_VEHICULO_INTERES
	,IF(NVL(P.SVMAMASTER,R.SVMAMASTER)=R.SVMAMASTER,R.SVMAMASTER,P.SVMAMASTER) SVMAMASTER
	,IF(NVL(P.SFX,R.SFX)=R.SFX,R.SFX,P.SFX) SFX
	,IF(NVL(P.COD_LINEA_NEGOCIO,R.COD_LINEA_NEGOCIO)=R.COD_LINEA_NEGOCIO,R.COD_LINEA_NEGOCIO,P.COD_LINEA_NEGOCIO) COD_LINEA_NEGOCIO
	,IF(NVL(P.LINEA_NEGOCIO,R.LINEA_NEGOCIO)=R.LINEA_NEGOCIO,R.LINEA_NEGOCIO,P.LINEA_NEGOCIO) LINEA_NEGOCIO
	,IF(NVL(P.NOMBRE,R.VEHICULO_INTERES)=R.VEHICULO_INTERES,R.FECHA_CARGA,CURRENT_TIMESTAMP) FECHA_CARGA
	FROM DWH.DIM_VEHICULOS_INTERES R
	LEFT JOIN (SELECT
			V.id, V.nombre, V.familia, V.tipo, V.SVMAMASTER, V.SFX, L.s3s_id AS COD_LINEA_NEGOCIO, L.name AS LINEA_NEGOCIO
			FROM
			',VAR_SCHEMA,'.CRM_PP_VEHICULOS_INTERESADO V
			INNER JOIN ',VAR_SCHEMA,'.CRM_CB_LINEANEGOCIO L ON V.linea_negocio = L.id) P ON R.COD_VEHICULO_INTERES = P.ID 			
	');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- ELIMINA LOS DATOS DE LA DIM
	VAR_SQL=CONCAT('TRUNCATE TABLE DWH.DIM_VEHICULOS_INTERES');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA LOS DATOS DE LA TMP1 A LA DIM
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_VEHICULOS_INTERES
	  (SK_VEHICULO_INTERES,COD_VEHICULO_INTERES,VEHICULO_INTERES,FAMILIA_VEHICULO_INTERES,TIPO_VEHICULO_INTERES,SVMAMASTER,SFX,COD_LINEA_NEGOCIO,LINEA_NEGOCIO,FECHA_CARGA)
          SELECT  A.SK_VEHICULO_INTERES,A.COD_VEHICULO_INTERES,A.VEHICULO_INTERES,A.FAMILIA_VEHICULO_INTERES,A.TIPO_VEHICULO_INTERES,A.SVMAMASTER,A.SFX,A.COD_LINEA_NEGOCIO,A.LINEA_NEGOCIO,A.FECHA_CARGA
	  FROM ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES A');
	  EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA TMP 
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES
			SELECT
			V.id, V.nombre, V.familia, V.tipo, V.SVMAMASTER, V.SFX, L.s3s_id, L.name
			FROM
			',VAR_SCHEMA,'.CRM_PP_VEHICULOS_INTERESADO V
			INNER JOIN ',VAR_SCHEMA,'.CRM_CB_LINEANEGOCIO L ON V.linea_negocio = L.id	
		    ');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA DIM 
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_VEHICULOS_INTERES
		(COD_VEHICULO_INTERES,VEHICULO_INTERES,FAMILIA_VEHICULO_INTERES,TIPO_VEHICULO_INTERES,SVMAMASTER,SFX,COD_LINEA_NEGOCIO,LINEA_NEGOCIO)
		SELECT A.ID,A.NOMBRE,NVL(A.FAMILIA,A.NOMBRE), NVL(A.TIPO,A.NOMBRE), A.SVMAMASTER, A.SFX, A.S3S_ID, A.NAME
		FROM ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES A
		LEFT JOIN DWH.DIM_VEHICULOS_INTERES B ON A.ID = B.COD_VEHICULO_INTERES
		WHERE B.VEHICULO_INTERES IS NULL 
		');
	 	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_VEHICULOS_INTERES');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

END;