CREATE OR REPLACE PROCEDURE `CRG_DIM_INTERESADO_TRAFICO`(VAR_SCHEMA varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL) RETURNS void AS
/***********************************************************************************************************************
  * Descripcion: Cargar Datos DIM_INTERESADO_TRAFICO
  * Version: 1.0.0
  * Fecha Creacion: 21/01/2020
  * Autor: Ivan Suasnavas
  * Comentario : Para Ejecutar = CALL CRG_DIM_INTERESADO_TRAFICO('SQUEMA')
  -------------------------------------------------------------------------
  * Fecha Modificacion:
  * Modificado:
*************************************************************************************************************************/
DECLARE
	VAR_SQL VARCHAR(4000);
	VAR_ERROR VARCHAR(4000);
	VAR_DT_INICIO TIMESTAMP = CURRENT_TIMESTAMP;
BEGIN
START TRANSACTION;
	INSERT INTO CTR.LOG_PROCESO (MODULO, ETAPA,DT_FECHA_INICIO) VALUES ('DIMENSION',CONCAT('INICIO ',VAR_SCHEMA,'.CRG_DIM_INTERESADO_TRAFICO'),VAR_DT_INICIO);
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

-- GUARDA EN UNA TABLA TEMPORAL LOS REGISTROS ACTUALIZADOS
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO  
	SELECT  R.SK_INTERESADO_TRAFICO,R.COD_INTERESADO_TRAFICO
	,IF(NVL(P.INTERESADO_TRAFICO,R.INTERESADO_TRAFICO)=R.INTERESADO_TRAFICO,R.INTERESADO_TRAFICO,P.INTERESADO_TRAFICO) INTERESADO_TRAFICO
	,IF(NVL(P.INTERESADO_TRAFICO,R.INTERESADO_TRAFICO)=R.INTERESADO_TRAFICO,R.FECHA_CARGA,CURRENT_TIMESTAMP) FECHA_CARGA
	FROM DWH.DIM_INTERESADO_TRAFICO R
	LEFT JOIN ',VAR_SCHEMA,'.CAT_INTERESADO_TRAFICO P ON R.COD_INTERESADO_TRAFICO = P.INTERESADO_TRAFICO 			
	');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- ELIMINA LOS DATOS DE LA DIM
	VAR_SQL=CONCAT('TRUNCATE TABLE DWH.DIM_INTERESADO_TRAFICO');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA LOS DATOS DE LA TMP1 A LA DIM
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_INTERESADO_TRAFICO
	  (SK_INTERESADO_TRAFICO,COD_INTERESADO_TRAFICO,INTERESADO_TRAFICO,FECHA_CARGA)
          SELECT  A.SK_INTERESADO_TRAFICO,A.COD_INTERESADO_TRAFICO,A.INTERESADO_TRAFICO,A.FECHA_CARGA
	  FROM ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO A');
	  EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA TMP 
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO
		SELECT 
			ID_INTERESADO_TRAFICO
			,INTERESADO_TRAFICO
			FROM ',VAR_SCHEMA,'.CAT_INTERESADO_TRAFICO A
     ');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA DIM 
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_INTERESADO_TRAFICO
		(COD_INTERESADO_TRAFICO,INTERESADO_TRAFICO)
		SELECT A.ID_INTERESADO_TRAFICO,A.INTERESADO_TRAFICO
		FROM ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO A
		LEFT JOIN DWH.DIM_INTERESADO_TRAFICO B ON A.ID_INTERESADO_TRAFICO = B.COD_INTERESADO_TRAFICO
		WHERE B.INTERESADO_TRAFICO IS NULL 
		');
	 	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_INTERESADO_TRAFICO');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

END;