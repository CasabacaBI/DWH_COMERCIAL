CREATE OR REPLACE PROCEDURE `CRG_DIM_NEGOCIACION`(VAR_SCHEMA varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL) RETURNS void AS
/***********************************************************************************************************************
  * Descripcion: Cargar Datos DIM_NEGOCIACION
  * Version: 1.0.0
  * Fecha Creacion: 28/01/2020
  * Autor: Ivan Suasnavas
  * Comentario : Para Ejecutar = CALL CRG_DIM_NEGOCIACION('SQUEMA')
  -------------------------------------------------------------------------
  * Fecha Modificacion:
  * Modificado:
*************************************************************************************************************************/
DECLARE
	VAR_SQL VARCHAR(4000);
	VAR_ERROR VARCHAR(4000);
	VAR_DT_INICIO TIMESTAMP = CURRENT_TIMESTAMP;
BEGIN
START TRANSACTION;
	INSERT INTO CTR.LOG_PROCESO (MODULO, ETAPA,DT_FECHA_INICIO) VALUES ('DIMENSION',CONCAT('INICIO ',VAR_SCHEMA,'.CRG_DIM_NEGOCIACION'),VAR_DT_INICIO);
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_NEGOCIACION');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

-- GUARDA EN UNA TABLA TEMPORAL LOS REGISTROS ACTUALIZADOS
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_NEGOCIACION  
	SELECT  R.SK_NEGOCIACION,R.ID_NEGOCIACION,R.COD_NEGOCIACION
	,IF(NVL(P.ESTADO_NEGOCIACION,R.ESTADO_NEGOCIACION)=R.ESTADO_NEGOCIACION,R.ESTADO_NEGOCIACION,P.ESTADO_NEGOCIACION) ESTADO_NEGOCIACION
	,IF(NVL(P.ESTADO_VENTA,R.ESTADO_VENTA)=R.ESTADO_VENTA,R.ESTADO_VENTA,P.ESTADO_VENTA) ESTADO_VENTA
	,IF(NVL(P.EFECTIVIDAD_MEDIOS,R.EFECTIVIDAD_MEDIOS)=R.EFECTIVIDAD_MEDIOS,R.EFECTIVIDAD_MEDIOS,P.EFECTIVIDAD_MEDIOS) EFECTIVIDAD_MEDIOS
	,IF(NVL(P.DATE_ENTERED,R.FECHA_CREACION)=R.FECHA_CREACION,R.FECHA_CREACION,P.DATE_ENTERED) FECHA_CREACION
	,IF(NVL(P.DATE_MODIFIED,R.FECHA_MODIFICACION)=R.FECHA_MODIFICACION,R.FECHA_MODIFICACION,P.DATE_MODIFIED) FECHA_MODIFICACION
	,IF(NVL(P.FECHA_INICIO,R.FECHA_INICIO)=R.FECHA_INICIO,R.FECHA_INICIO,P.FECHA_INICIO) FECHA_INICIO
	,IF(NVL(P.FECHA_FIN,R.FECHA_FIN)=R.FECHA_FIN,R.FECHA_FIN,P.FECHA_FIN) FECHA_FIN
	,IF(NVL(P.ULT_FECHA_VISITA,R.FECHA_ULTIMA_VISITA)=R.FECHA_ULTIMA_VISITA,R.FECHA_ULTIMA_VISITA,P.ULT_FECHA_VISITA) FECHA_ULTIMA_VISITA
	,IF(NVL(P.ULT_FECHA_COACHING,R.FECHA_ULTIMO_COACHING)=R.FECHA_ULTIMO_COACHING,R.FECHA_ULTIMO_COACHING,P.ULT_FECHA_COACHING) FECHA_ULTIMO_COACHING
	,IF(NVL(P.ULT_COMENT_ASESOR,R.ULTIMO_COMENTARIO_ASESOR)=R.ULTIMO_COMENTARIO_ASESOR,R.ULTIMO_COMENTARIO_ASESOR,P.ULT_COMENT_ASESOR) ULTIMO_COMENTARIO_ASESOR
	,IF(NVL(P.ULT_COMENT_COACH,R.ULTIMO_COMENTARIO_COACH)=R.ULTIMO_COMENTARIO_COACH,R.ULTIMO_COMENTARIO_COACH,P.ULT_COMENT_COACH) ULTIMO_COMENTARIO_COACH
	,IF(NVL(P.ULT_COMENT_COORD,R.ULTIMO_COMENTARIO_COORDINADOR)=R.ULTIMO_COMENTARIO_COORDINADOR,R.ULTIMO_COMENTARIO_COORDINADOR,P.ULT_COMENT_COORD) ULTIMO_COMENTARIO_COORDINADOR
	,IF(NVL(P.TIPO_IDENTIFICACION,R.TIPO_IDENTIFICACION_CLIENTE)=R.TIPO_IDENTIFICACION_CLIENTE,R.TIPO_IDENTIFICACION_CLIENTE,P.TIPO_IDENTIFICACION) TIPO_IDENTIFICACION_CLIENTE
	,IF(NVL(P.NUMERO_IDENTIFICACION,R.IDENTIFICACION_CLIENTE)=R.IDENTIFICACION_CLIENTE,R.IDENTIFICACION_CLIENTE,P.NUMERO_IDENTIFICACION) IDENTIFICACION_CLIENTE
	,IF(NVL(P.NOMBRES,R.NOMBRE_CLIENTE)=R.NOMBRE_CLIENTE,R.NOMBRE_CLIENTE,P.NOMBRES) NOMBRE_CLIENTE
	,IF(NVL(P.APELLIDOS,R.APELLIDO_CLIENTE)=R.APELLIDO_CLIENTE,R.APELLIDO_CLIENTE,P.APELLIDOS) APELLIDO_CLIENTE
	,IF(NVL(P.TELEFONO,R.TELEFONO_CLIENTE)=R.TELEFONO_CLIENTE,R.TELEFONO_CLIENTE,P.TELEFONO) TELEFONO_CLIENTE
	,IF(NVL(P.EMAIL,R.EMAIL_CLIENTE)=R.EMAIL_CLIENTE,R.EMAIL_CLIENTE,P.EMAIL) EMAIL_CLIENTE
	,IF(NVL(P.POTENCIALIDAD,R.POTENCIALIDAD)=R.POTENCIALIDAD,R.POTENCIALIDAD,P.POTENCIALIDAD) POTENCIALIDAD
	,IF(NVL(P.ESTADO_NEGOCIACION,R.ESTADO_NEGOCIACION)=R.ESTADO_NEGOCIACION,R.FECHA_CARGA,CURRENT_TIMESTAMP) FECHA_CARGA
	FROM DWH.DIM_NEGOCIACION R
	LEFT JOIN ',VAR_SCHEMA,'.CRM_CB_NEGOCIACION P ON R.ID_NEGOCIACION = P.ID AND R.COD_NEGOCIACION = P.NAME AND R.ESTADO_NEGOCIACION = P.ESTADO_NEGOCIACION
	AND R.EFECTIVIDAD_MEDIOS = P.EFECTIVIDAD_MEDIOS		
	');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- ELIMINA LOS DATOS DE LA DIM
	VAR_SQL=CONCAT('TRUNCATE TABLE DWH.DIM_NEGOCIACION');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA LOS DATOS DE LA TMP1 A LA DIM
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_NEGOCIACION
	  (SK_NEGOCIACION, ID_NEGOCIACION, COD_NEGOCIACION, ESTADO_NEGOCIACION, ESTADO_VENTA, EFECTIVIDAD_MEDIOS, FECHA_CREACION, FECHA_MODIFICACION, 
	  FECHA_INICIO, FECHA_FIN, FECHA_ULTIMA_VISITA, FECHA_ULTIMO_COACHING, ULTIMO_COMENTARIO_ASESOR, ULTIMO_COMENTARIO_COACH, 
	  ULTIMO_COMENTARIO_COORDINADOR, TIPO_IDENTIFICACION_CLIENTE, IDENTIFICACION_CLIENTE, NOMBRE_CLIENTE, APELLIDO_CLIENTE, TELEFONO_CLIENTE, 
	  EMAIL_CLIENTE, POTENCIALIDAD, FECHA_CARGA)
      SELECT SK_NEGOCIACION, ID_NEGOCIACION, COD_NEGOCIACION, ESTADO_NEGOCIACION, ESTADO_VENTA, EFECTIVIDAD_MEDIOS, FECHA_CREACION, 
	  FECHA_MODIFICACION, FECHA_INICIO, FECHA_FIN, FECHA_ULTIMA_VISITA, FECHA_ULTIMO_COACHING, ULTIMO_COMENTARIO_ASESOR, ULTIMO_COMENTARIO_COACH, 
	  ULTIMO_COMENTARIO_COORDINADOR, TIPO_IDENTIFICACION_CLIENTE, IDENTIFICACION_CLIENTE, NOMBRE_CLIENTE, APELLIDO_CLIENTE, TELEFONO_CLIENTE, 
	  EMAIL_CLIENTE, POTENCIALIDAD, FECHA_CARGA
	  FROM ',VAR_SCHEMA,'.TMP_NEGOCIACION A');
	  EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_NEGOCIACION');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA TMP 
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_NEGOCIACION
		SELECT 
			ID, NAME, estado_negociacion , ESTADO_VENTA, efectividad_medios ,DATE_ENTERED ,DATE_MODIFIED
			,FECHA_INICIO ,FECHA_FIN ,ULT_FECHA_VISITA ,ULT_FECHA_COACHING ,ULT_COMENT_ASESOR
			,ULT_COMENT_COACH ,ULT_COMENT_COORD ,TIPO_IDENTIFICACION ,NUMERO_IDENTIFICACION
			,NOMBRES ,APELLIDOS ,TELEFONO ,EMAIL ,POTENCIALIDAD
			FROM ',VAR_SCHEMA,'.CRM_CB_NEGOCIACION 
     ');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA DIM 
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_NEGOCIACION
		(ID_NEGOCIACION, COD_NEGOCIACION, ESTADO_NEGOCIACION, ESTADO_VENTA, EFECTIVIDAD_MEDIOS, FECHA_CREACION, FECHA_MODIFICACION,
		 FECHA_INICIO, FECHA_FIN, FECHA_ULTIMA_VISITA, FECHA_ULTIMO_COACHING, ULTIMO_COMENTARIO_ASESOR, ULTIMO_COMENTARIO_COACH, 
		 ULTIMO_COMENTARIO_COORDINADOR, TIPO_IDENTIFICACION_CLIENTE, IDENTIFICACION_CLIENTE, NOMBRE_CLIENTE, APELLIDO_CLIENTE, 
		 TELEFONO_CLIENTE, CELULAR_CLIENTE, EMAIL_CLIENTE, POTENCIALIDAD)
		SELECT 
			A.ID, NAME, A.estado_negociacion, A.estado_venta , A.efectividad_medios ,DATE_ENTERED ,DATE_MODIFIED
			,A.FECHA_INICIO ,A.FECHA_FIN ,ULT_FECHA_VISITA ,ULT_FECHA_COACHING ,ULT_COMENT_ASESOR
			,ULT_COMENT_COACH ,ULT_COMENT_COORD ,A.TIPO_IDENTIFICACION ,A.NUMERO_IDENTIFICACION
			,NOMBRES ,APELLIDOS ,TELEFONO, CELULAR ,EMAIL ,A.POTENCIALIDAD 
		FROM ',VAR_SCHEMA,'.CRM_CB_NEGOCIACION A
		LEFT JOIN DWH.DIM_NEGOCIACION B ON A.ID = B.ID_NEGOCIACION AND A.NAME = B.COD_NEGOCIACION AND A.ESTADO_NEGOCIACION = B.ESTADO_NEGOCIACION 
				AND A.ESTADO_NEGOCIACION = B.ESTADO_NEGOCIACION
		WHERE B.ESTADO_NEGOCIACION IS NULL 
		');
	 	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_NEGOCIACION');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

END;