CREATE OR REPLACE PROCEDURE `CRG_DIM_HISTORIAL_COACHING`(VAR_SCHEMA varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL) RETURNS void AS
/***********************************************************************************************************************
  * Descripcion: Cargar Datos DIM_HISTORIAL_COACHING
  * Version: 1.0.0
  * Fecha Creacion: 18/02/2020
  * Autor: Ivan Suasnavas
  * Comentario : Para Ejecutar = CALL CRG_DIM_HISTORIAL_COACHING('SQUEMA')
  -------------------------------------------------------------------------
  * Fecha Modificacion:
  * Modificado:
*************************************************************************************************************************/
DECLARE
	VAR_SQL VARCHAR(4000);
	VAR_ERROR VARCHAR(4000);
	VAR_DT_INICIO TIMESTAMP = CURRENT_TIMESTAMP;
BEGIN
START TRANSACTION;
	INSERT INTO CTR.LOG_PROCESO (MODULO, ETAPA,DT_FECHA_INICIO) VALUES ('DIMENSION',CONCAT('INICIO ',VAR_SCHEMA,'.CRG_DIM_HISTORIAL_COACHING'),VAR_DT_INICIO);
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

-- GUARDA EN UNA TABLA TEMPORAL LOS REGISTROS ACTUALIZADOS
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING 
	SELECT  R.SK_HISTORIAL_COACHING,R.COD_HISTORIAL_COACHING,R.COACHING
	,IF(NVL(P.DATE_ENTERED,R.FECHA_CREACION)=R.FECHA_CREACION,R.FECHA_CREACION,P.DATE_ENTERED) FECHA_CREACION
	,IF(NVL(P.DATE_MODIFIED,R.FECHA_MODIFICACION)=R.FECHA_MODIFICACION,R.FECHA_MODIFICACION,P.DATE_MODIFIED) FECHA_MODIFICACION
	,IF(NVL(P.DESCRIPTION,R.DESCRIPCION)=R.DESCRIPCION,R.DESCRIPCION,P.DESCRIPTION) DESCRIPCION
	,IF(NVL(P.COMENTARIO_COACH,R.COMENTARIO_COACH)=R.COMENTARIO_COACH,R.COMENTARIO_COACH,P.COMENTARIO_COACH) COMENTARIO_COACH
	,IF(NVL(P.COMENTARIOASESOR,R.COMENTARIO_ASESOR)=R.COMENTARIO_ASESOR,R.COMENTARIO_ASESOR,P.COMENTARIOASESOR) COMENTARIO_ASESOR
	,IF(NVL(P.COMENTARIOCOORDINADOR,R.COMENTARIO_COORDINADOR)=R.COMENTARIO_COORDINADOR,R.COMENTARIO_COORDINADOR,P.COMENTARIOCOORDINADOR) COMENTARIO_COORDINADOR
	,IF(NVL(P.FECHA_COACHING,R.FECHA_COACHING)=R.FECHA_COACHING,R.FECHA_COACHING,P.FECHA_COACHING) FECHA_COACHING
	,IF(NVL(P.DESEA_ASIGNAR_VISITA,R.DESEA_ASIGNAR_VISITA)=R.DESEA_ASIGNAR_VISITA,R.DESEA_ASIGNAR_VISITA,P.DESEA_ASIGNAR_VISITA) DESEA_ASIGNAR_VISITA
	,IF(NVL(P.DESEA_ASIGNAR_LLAMADA,R.DESEA_ASIGNAR_LLAMADA)=R.DESEA_ASIGNAR_LLAMADA,R.DESEA_ASIGNAR_LLAMADA,P.DESEA_ASIGNAR_LLAMADA) DESEA_ASIGNAR_LLAMADA
	,IF(NVL(P.FECHA_AGENDAMIENTO,R.FECHA_AGENDAMIENTO)=R.FECHA_AGENDAMIENTO,R.FECHA_AGENDAMIENTO,P.FECHA_AGENDAMIENTO) FECHA_AGENDAMIENTO
	,IF(NVL(P.ESTADO_COACHING,R.COD_ESTADO_COACHING)=R.COD_ESTADO_COACHING,R.COD_ESTADO_COACHING,P.ESTADO_COACHING) COD_ESTADO_COACHING
	,IF(NVL(P.MOTIVO_CIERRE,R.COD_MOTIVO_CIERRE)=R.COD_MOTIVO_CIERRE,R.COD_MOTIVO_CIERRE,P.MOTIVO_CIERRE) COD_MOTIVO_CIERRE
	,IF(NVL(P.MOTIVO_OTRO,R.MOTIVO_OTRO)=R.MOTIVO_OTRO,R.MOTIVO_OTRO,P.MOTIVO_OTRO) MOTIVO_OTRO
	,IF(NVL(P.NAME,R.COACHING)=R.COACHING,R.FECHA_CARGA,CURRENT_TIMESTAMP) FECHA_CARGA
	FROM DWH.DIM_HISTORIAL_COACHING R
	LEFT JOIN ',VAR_SCHEMA,'.CRM_CB_HISTORIALCOACHING P ON R.COD_ESTADO_COACHING = P.ID 			
	');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- ELIMINA LOS DATOS DE LA DIM
	VAR_SQL=CONCAT('TRUNCATE TABLE DWH.DIM_HISTORIAL_COACHING');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA LOS DATOS DE LA TMP1 A LA DIM
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_HISTORIAL_COACHING
	  (SK_HISTORIAL_COACHING, COD_HISTORIAL_COACHING, COACHING, FECHA_CREACION, FECHA_MODIFICACION, DESCRIPCION, COMENTARIO_COACH, COMENTARIO_ASESOR, COMENTARIO_COORDINADOR, FECHA_COACHING, DESEA_ASIGNAR_VISITA, DESEA_ASIGNAR_LLAMADA, FECHA_AGENDAMIENTO, COD_ESTADO_COACHING, COD_MOTIVO_CIERRE, MOTIVO_OTRO, FECHA_CARGA)
          SELECT SK_HISTORIAL_COACHING, COD_HISTORIAL_COACHING, COACHING, FECHA_CREACION, FECHA_MODIFICACION, DESCRIPCION, COMENTARIO_COACH, COMENTARIO_ASESOR, COMENTARIO_COORDINADOR, FECHA_COACHING, DESEA_ASIGNAR_VISITA, DESEA_ASIGNAR_LLAMADA, FECHA_AGENDAMIENTO, COD_ESTADO_COACHING, COD_MOTIVO_CIERRE, MOTIVO_OTRO, FECHA_CARGA
	  FROM ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING A');
	  EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;
	
	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA TMP 
	VAR_SQL=CONCAT('CREATE TABLE ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING
		SELECT 
			id, name, timestampadd(HOUR,-5,date_entered) date_entered, timestampadd(HOUR,-5,date_modified) date_modified, description, comentario_coach, comentarioasesor, comentariocoordinador, 
			timestampadd(HOUR,-5,fecha_coaching) fecha_coaching, desea_asignar_visita, desea_asignar_llamada, timestampadd(HOUR,-5,fecha_agendamiento) fecha_agendamiento, estado_coaching, motivo_cierre, 
			motivo_otro
			FROM ',VAR_SCHEMA,'.CRM_CB_HISTORIALCOACHING A
     ');
	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	-- INSERTA NUEVOS REGISTROS A LA DIM 
	VAR_SQL=CONCAT('INSERT INTO DWH.DIM_HISTORIAL_COACHING
		(COD_HISTORIAL_COACHING, COACHING, FECHA_CREACION, FECHA_MODIFICACION, DESCRIPCION, COMENTARIO_COACH, COMENTARIO_ASESOR, COMENTARIO_COORDINADOR, FECHA_COACHING, DESEA_ASIGNAR_VISITA, DESEA_ASIGNAR_LLAMADA, FECHA_AGENDAMIENTO, COD_ESTADO_COACHING, COD_MOTIVO_CIERRE, MOTIVO_OTRO)
		SELECT A.id, A.name, A.date_entered, A.date_modified, A.description, A.comentario_coach, A.comentarioasesor, A.comentariocoordinador, 
		A.fecha_coaching, A.desea_asignar_visita, A.desea_asignar_llamada, A.fecha_agendamiento, A.estado_coaching, A.motivo_cierre, 
		A.motivo_otro
		FROM DSA.TMP_HISTORIAL_COACHING A
		LEFT JOIN DWH.DIM_HISTORIAL_COACHING B ON A.ID = B.COD_HISTORIAL_COACHING
		WHERE B.COACHING IS NULL 
		');
	 	EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

	VAR_SQL=CONCAT('DROP TABLE IF EXISTS ',VAR_SCHEMA,'.TMP_HISTORIAL_COACHING');
	 EXECUTE IMMEDIATE VAR_SQL;
	COMMIT;

END;